<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Swift Package Manager builds iOS frameworks (Updated. Xcode 10.2 Beta)</title>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swift Package Manager builds iOS frameworks (Updated. Xcode 10.2 Beta)"/>
<meta name="twitter:description" content="Swift Package Manager doesn&rsquo;t work with iOS. Probably, that&rsquo;s all you can say about the current state of SPM, but insomnia forced me to extend the answer to the following essay."/>

    
    

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">

    
  </head>
  <body>
    <header>
  <div id="header-container">
    <div>
      <span>
        <a href="http://dive.github.io/">Home</a>
        <a href="http://dive.github.io/index.xml">RSS</a>
        
      </span>
    </div>
    <div>
      <span>
        <a href="https://github.com/dive">GitHub</a>
        <a href="https://twitter.com/justsitandgrin">Twitter</a>
        <a href="https://www.linkedin.com/in/artemloenko">LinkedIn</a>
      </span>
    </div>
  </div>
  
</header>

    
	<main>
		<article>
			<h1 class="title">Swift Package Manager builds iOS frameworks (Updated. Xcode 10.2 Beta)</h1>
			<time>20.01.2019 09:25</time>
			<div>
				<p>Swift Package Manager doesn&rsquo;t work with iOS. Probably, that&rsquo;s all you can say about the current state of SPM, but insomnia forced me to extend the answer to the following essay.</p>
<h2 id="tl-dr">TL;DR</h2>
<ul>
<li>Yes, you can build iOS frameworks with Swift Package Manager;</li>
<li>Yes, you can adjust settings via <code>.xcconfig</code> and reuse generated <code>.xcodeproj</code> in a real iOS application without 3rd party tools to parse a project structure, scripts on Ruby, etc.;</li>
<li>Yes, you can use <code>swift build</code> to build your package but only as a library (though, with some additional limitations);</li>
<li>No, you can not use <code>swift test</code> because you have to spawn a simulator to run them.</li>
</ul>
<h2 id="current-state-of-swift-package-manager">Current State of Swift Package Manager</h2>
<p>iOS support is a hot topic in <a href="https://swift.org/package-manager/">Swift Package Manager</a> community, and from time to time someone raises this question again, but the reaction can be summarised to the following comments (<a href="https://forums.swift.org/t/spm-roadmap/6870">full thread</a> on forums.swift.org):</p>
<p>@<a href="https://forums.swift.org/u/rballard">Rick Ballard</a></p>
<blockquote>
<p>I think that this will be <strong>best provided by native IDE integration</strong>. However, in the meantime, I&rsquo;d welcome contributions to help improve Xcode&rsquo;s project generation support.</p>
</blockquote>
<p>@<a href="https://forums.swift.org/u/akashivskyy">Adrian Kashivskyy</a></p>
<blockquote>
<p>The last thing I want from a platform-agnostic open-source package manager is built-in integration with a single-platform commercial closed-source IDE. üòï
I think this should be done independently by DT team, without any special favouritism by SPM.</p>
</blockquote>
<p>And you know what? I agree with these statements. Especially after some researches. In general, SPM is a very &lsquo;young&rsquo; and inflexible project. There are a lot of limitations, especially around <code>generate-xcodeproj</code> options of <code>swift package</code> tool, and it is understandable. Swift is a language, and all related tools should be platform-agnostic as much as possible. Yeah, iOS is the biggest Swift consumer, and Apple contributes to Swift mostly because of iOS. But. It&rsquo;s almost impossible to grow Swift to a mature technology if you&rsquo;re limited and restricted by Xcode / iOS specific things / etc. And, it seems, this is the primary goal for Swift. Just be a language. The fate of Objective C is a good example of why Apple and Swift&rsquo;s community are trying to be agnostic. They are trying to build something big, and lack of iOS support is the price (among many others) at the moment. üíã</p>
<p>Anyway, we have exciting news about SPM and iOS friendship. <a href="https://forums.swift.org/t/accepted-with-modifications-se-0236-package-manager-platform-deployment-settings/18420">SE-0236: Package Manager Platform Deployment Settings</a> is accepted with some modifications. And the implementation of this proposal will help a lot to move forward in case of iOS. The base goal is clear and straightforward:</p>
<blockquote>
<p>Packages should be able to declare the minimum required platform deployment target version. SwiftPM currently uses a hardcoded value for the macOS deployment target. This creates friction for packages which want to use APIs that were introduced after the hardcoded deployment target version.</p>
</blockquote>
<p>Why will it not solve the problem with iOS support at all? Just read the <a href="https://github.com/apple/swift-evolution/blob/master/proposals/0236-package-manager-platform-deployment-settings.md">&ldquo;This proposal doesn&rsquo;t handle these problems&rdquo;</a> section.</p>
<h3 id="xcode-10-dot-2-beta">Xcode 10.2 Beta</h3>
<p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0236-package-manager-platform-deployment-settings.md">SE-0236</a> was accepted and implemented in Swift 5, and Apple shipped it with the latest Xcode 10.2 beta. It means that you can specify an iOS as a deployment target for your packages with a simple line in your <code>Package.swift</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#93a1a1;font-style:italic">// Specify target platforms</span>
<span style="color:#268bd2">platforms</span>: [ .<span style="color:#268bd2">iOS</span>(.<span style="color:#268bd2">v12</span>) ]
</code></pre></div><p>You can find an example in <code>xcode_10_2_beta</code> branch in the example <a href="https://github.com/dive/spm-ios-example/tree/xcode%5F10%5F2%5Fbeta">repository</a>. It is still a beta implementation, and you will have a lot of issues with <code>build</code> command, <code>run</code> doesn&rsquo;t work as well, but this is a step forward to support iOS finally.</p>
<p>I hope that Apple will announce something <strong>good</strong> on WWDC'19. New IDE for Swift? Open sourced <code>xcodebuild</code>? <code>xcodebuild</code> replacement based on <code>llbuild</code>? Will see. The current state is complicated as much as it can be. We are trying to inject open-sourced platform-agnostic tools into a legacy (?) world of Xcode, and this problem can be solved only in two ways: iOS specific build tools go open source, or Xcode team supports Swift infrastructure.</p>
<h2 id="is-it-possible-to-build-an-ios-framework-with-spm-yes-yes-it-is">Is it possible to build an iOS framework with SPM? Yes! Yes, it is!</h2>
<p>So. If you try to search for solutions to build iOS frameworks with SPM on DuckDuckGo, you will find some instructions (<a href="https://github.com/j-channings/swift-package-manager-ios">1</a>, <a href="https://www.ralfebert.de/ios/swift-package-manager-for-ios-projects/">2</a>). But all of them have this step that I hate: <code>sudo gem install xcodeproj</code> :disgusting:. Can we do better? Let&rsquo;s try.</p>
<p>First of all, let&rsquo;s generate a template:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#93a1a1;font-style:italic"># Initialise a package with a library type</span>
swift package init --type library
</code></pre></div><p>Now we have to convince SPM that we want an iOS project when it generates <code>xcodeproj</code>. How? With <code>xcconfig</code>, of course. Create a file <code>ios.xcconfig</code> and put it to <code>./Sources</code> folder. For example, let&rsquo;s start with a basic version:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#268bd2">SDKROOT</span> = iphoneos
<span style="color:#268bd2">SUPPORTED_PLATFORMS</span> = iphonesimulator iphoneos
<span style="color:#268bd2">IPHONEOS_DEPLOYMENT_TARGET</span> = 12.0

<span style="color:#268bd2">ARCHS</span> = <span style="color:#859900">$(</span>ARCHS_STANDARD<span style="color:#859900">)</span>
<span style="color:#268bd2">VALID_ARCHS</span> = <span style="color:#859900">$(</span>ARCHS_STANDARD<span style="color:#859900">)</span>

<span style="color:#268bd2">VALIDATE_PRODUCT</span> = YES
<span style="color:#268bd2">LD_RUNPATH_SEARCH_PATHS</span> = <span style="color:#859900">$(</span>inherited<span style="color:#859900">)</span> @executable_path/Frameworks
<span style="color:#268bd2">TARGETED_DEVICE_FAMILY</span> = 1, <span style="color:#2aa198;font-weight:bold">2</span>
</code></pre></div><p>Looks good. Let&rsquo;s see what SPM thinks about it:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#93a1a1;font-style:italic"># Generate .xcodeproj file for the package in the current folder</span>
swift package generate-xcodeproj --xcconfig-overrides ./Sources/ios.xcconfig
</code></pre></div><p>Did not know about <code>xcconfig-overrides</code>? Me either. It&rsquo;s a hidden and undocumented feature (<a href="https://github.com/apple/swift-package-manager/commit/713a3e603e6682fe431074617343eb05852d10c5">commit</a>), thanks to <a href="https://github.com/ddunbar">@Daniel Dunbar</a>! Time to ask Xcode what it thinks about it.</p>
<figure><img src="/images/xcode_spm_build_results.png"/>
</figure>

<p><strong>Note</strong>: You do not have to specify a custom <code>.xcconfig</code> file if you are using Xcode 10.2 Beta with Swift 5 Toolchain. Check the <a href="https://github.com/dive/spm-ios-example/tree/xcode%5F10%5F2%5Fbeta">branch</a> for more details.</p>
<p>It works! Let&rsquo;s celebrate! But nope. We&rsquo;re not on Medium, so let&rsquo;s try to dig deeper. Let&rsquo;s check how the &lsquo;Unit Tests&rsquo; target works, for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">spm-tutorial/Tests/spm-tutorialTests/XCTestManifests.swift:4:28: error: use of undeclared <span style="color:#cb4b16">type</span> <span style="color:#2aa198">&#39;XCTestCaseEntry&#39;</span>
public func allTests() -&gt; [XCTestCaseEntry] {
                           ^~~~~~~~~~~~~~~
</code></pre></div><p>It doesn&rsquo;t. Due to this strange and suspicious <code>XCTestCaseEntry</code>. What is this? According to the <a href="https://github.com/apple/swift-corelibs-xctest/blob/237d97cadbc3c51d575c705bf8e4d8456a12827a/Sources/XCTest/Public/XCTestCase.swift#L24">swift-corelibs-xctest</a> source code:</p>
<blockquote>
<p>This is a compound type used by <code>XCTMain</code> to represent tests to run. It combines an <code>XCTestCase</code> subclass type with the list of test case methods to invoke on the class.</p>
</blockquote>
<p>And the <code>typealias</code> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">...
<span style="color:#859900">public</span> <span style="color:#859900">typealias</span> <span style="color:#268bd2">XCTestCaseEntry</span> = (<span style="color:#268bd2">testCaseClass</span>: <span style="color:#268bd2">XCTestCase</span>.<span style="color:#859900">Type</span>, <span style="color:#268bd2">allTests</span>: [(<span style="color:#cb4b16">String</span>, <span style="color:#268bd2">XCTestCaseClosure</span>)])
...
</code></pre></div><p>Why it doesn&rsquo;t work? The same:</p>
<blockquote>
<p>CoreLibs XCTest only supports desktop platforms</p>
</blockquote>
<p>Thanks to <a href="https://github.com/larryonoff">@larryonoff</a> and <a href="https://github.com/apple/swift-corelibs-xctest/pull/176">his work</a> on multi-platform support. But it&rsquo;s still impossible to use it for our needs. You can join this <a href="https://github.com/apple/swift-corelibs-xctest/pull/61">Add Unit Testing Infrastructure</a> thread if you want to learn more about the current state of <code>swift-corelibs-xctest</code>. We will skip this topic and apply the fix to <code>XCTestManifests.swift</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#859900">import</span> <span style="color:#cb4b16">XCTest</span>

<span style="color:#93a1a1;font-style:italic">#if</span> !<span style="color:#93a1a1;font-style:italic">os</span>(<span style="color:#93a1a1;font-style:italic">macOS</span>) &amp;&amp; !<span style="color:#93a1a1;font-style:italic">os</span>(<span style="color:#93a1a1;font-style:italic">iOS</span>)
<span style="color:#859900">public</span> <span style="color:#859900">func</span> <span style="color:#268bd2">allTests</span>() -&gt; [<span style="color:#268bd2">XCTestCaseEntry</span>] {
    <span style="color:#859900">return</span> [
        <span style="color:#268bd2">testCase</span>(<span style="color:#268bd2">spm_tutorialTests</span>.<span style="color:#268bd2">allTests</span>),
    ]
}
<span style="color:#93a1a1;font-style:italic">#endif</span>
</code></pre></div><p>See this <code>&amp;&amp; !os(iOS)</code>? It&rsquo;s enough to continue our journey. Run Tests again and&hellip; We got what we need.</p>
<figure><img src="/images/xcode_spm_test_results.png"/>
</figure>

<p>Then I created a simple iOS <code>ExampleApp</code> and added the generated <code>xcodeproj</code> as a dependency. Of course, I&rsquo;ve added some iOS specific code to the framework:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#859900">import</span> <span style="color:#cb4b16">UIKit</span>

<span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">FrameworkPackage</span> {
    <span style="color:#859900">public</span> <span style="color:#859900">init</span> () { }
    <span style="color:#859900">public</span> <span style="color:#859900">func</span> <span style="color:#268bd2">randomColor</span>() -&gt; <span style="color:#268bd2">UIColor</span> {
        <span style="color:#859900">return</span> <span style="color:#268bd2">UIColor</span>.<span style="color:#268bd2">random</span>
    }
}

<span style="color:#859900">public</span> <span style="color:#859900">extension</span> <span style="color:#cb4b16">UIColor</span> {
    <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900">var</span> <span style="color:#268bd2">random</span>: <span style="color:#268bd2">UIColor</span> {
        <span style="color:#859900">return</span> <span style="color:#268bd2">UIColor</span>(<span style="color:#268bd2">red</span>: .<span style="color:#268bd2">random</span>(<span style="color:#859900">in</span>: <span style="color:#2aa198;font-weight:bold">0.</span>..<span style="color:#2aa198;font-weight:bold">1</span>), <span style="color:#268bd2">green</span>: .<span style="color:#268bd2">random</span>(<span style="color:#859900">in</span>: <span style="color:#2aa198;font-weight:bold">0.</span>..<span style="color:#2aa198;font-weight:bold">1</span>), <span style="color:#268bd2">blue</span>: .<span style="color:#268bd2">random</span>(<span style="color:#859900">in</span>: <span style="color:#2aa198;font-weight:bold">0.</span>..<span style="color:#2aa198;font-weight:bold">1</span>), <span style="color:#268bd2">alpha</span>: <span style="color:#2aa198;font-weight:bold">1</span>)
    }
}
</code></pre></div><p>And then reuse it from the example app:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#859900">import</span> <span style="color:#cb4b16">UIKit</span>
<span style="color:#859900">import</span> <span style="color:#cb4b16">class</span> <span style="color:#cb4b16">ios_framework_package</span>.<span style="color:#cb4b16">FrameworkPackage</span>

<span style="color:#859900">class</span> <span style="color:#cb4b16">ViewController</span>: <span style="color:#268bd2">UIViewController</span> {

    <span style="color:#859900">override</span> <span style="color:#859900">func</span> <span style="color:#268bd2">viewDidLoad</span>() {
        <span style="color:#859900;font-weight:bold">super</span>.<span style="color:#268bd2">viewDidLoad</span>()
        <span style="color:#859900;font-weight:bold">self</span>.<span style="color:#268bd2">view</span>.<span style="color:#268bd2">backgroundColor</span> = <span style="color:#268bd2">FrameworkPackage</span>().<span style="color:#268bd2">randomColor</span>()
    }

    <span style="color:#859900">@IBAction</span> <span style="color:#859900">func</span> <span style="color:#268bd2">pressed</span>(<span style="color:#859900;font-weight:bold">_</span> <span style="color:#268bd2">button</span>: <span style="color:#268bd2">UIButton</span>) {
        <span style="color:#859900;font-weight:bold">self</span>.<span style="color:#268bd2">view</span>.<span style="color:#268bd2">backgroundColor</span> = <span style="color:#268bd2">FrameworkPackage</span>().<span style="color:#268bd2">randomColor</span>()
    }

}
</code></pre></div><p>The full example is available on <a href="https://github.com/dive/spm-ios-example">GitHub</a>.
Thanks to <code>CLANG_MODULES_AUTOLINK</code>, all iOS frameworks will be linked automatically. I didn&rsquo;t try more complex scenarios (when one iOS module depends on another, etc.) because it&rsquo;s not my goal at the moment. But in general, it just works with some limitations. SPM doesn&rsquo;t set up our <code>xcconfig</code> for some targets, and you have to include the SPM-generated <code>.xcodeproj</code> to your <code>.xcodeproj</code>, but all these tradeoffs seem reasonable for this research and our current goal.</p>
<h2 id="back-to-swift-package-manager">Back to Swift Package Manager</h2>
<p>See. We can do better. But we forgot about SPM during this Xcode journey. Let&rsquo;s close our fancy dark-themed Xcode, open Terminal and run <code>swift build</code> for our iOS&rsquo;ish package (I&rsquo;m going to use the package from the <a href="https://github.com/dive/spm-ios-example">example project</a> mentioned above):</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Compile Swift Module <span style="color:#2aa198">&#39;ios_framework_package&#39;</span> (<span style="color:#2aa198;font-weight:bold">1</span> sources)
./spm-ios-example/ios-framework-package/Sources/ios-framework-package/ios_framework_package.swift:1:8: error: no such module <span style="color:#2aa198">&#39;UIKit&#39;</span>
import UIKit
       ^
error: terminated(1): /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-build-tool -f./spm-ios-example/ios-framework-package/.build/debug.yaml main output: ...
</code></pre></div><p>Okay. <code>no such module 'UIKit'</code>. Can we do better? Doubt it. But let&rsquo;s try. First of all, we have to know where SPM gets all these environment variables, we can ask it with <code>swift build --verbose</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">xcrun --sdk macosx --show-sdk-path
xcrun --sdk macosx --show-sdk-platform-path
xcrun --find clang
xcrun --sdk macosx --find xctest
sandbox-exec -p &#39;(version 1)
</code></pre></div><p>Nice. No magic and jigsaws. Let&rsquo;s try to change some <code>swiftc</code> options to build the project against proper <code>sdk</code> and <code>target</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">swift build <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-sdk&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;`xcrun --sdk iphonesimulator --show-sdk-path`&#34;</span> <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-target&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;x86_64-apple-ios12.1-simulator&#34;</span>
</code></pre></div><p>Looks better. We built the binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">...
Compile Swift Module <span style="color:#2aa198">&#39;ios_framework_package&#39;</span> (<span style="color:#2aa198;font-weight:bold">1</span> sources)
</code></pre></div><p>Let&rsquo;s make some inspections, just to be sure that everything is fine:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ lipo -archs .build/x86_64-apple-macosx10.10/debug/ios_framework_package.build/ios_framework_package.swift.o
x86_64
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nm -extern-only -defined-only -just-symbol-name .build/x86_64-apple-macosx10.10/debug/ios_framework_package.build/ios_framework_package.swift.o
_<span style="color:#268bd2">$S12CoreGraphics7CGFloatVACSBAAWL</span>
_<span style="color:#268bd2">$S12CoreGraphics7CGFloatVACSBAAWl</span>
_<span style="color:#268bd2">$S12CoreGraphics7CGFloatVACSLAAWL</span>
_<span style="color:#268bd2">$S12CoreGraphics7CGFloatVACSLAAWl</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageC11randomColorSo7UIColorCyF</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCACycfC</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCACycfc</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCMa</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCMm</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCMn</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCN</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCfD</span>
_<span style="color:#268bd2">$S21ios_framework_package16FrameworkPackageCfd</span>
_<span style="color:#268bd2">$S21ios_framework_packageMXM</span>
_<span style="color:#268bd2">$SSo7UIColorC21ios_framework_packageE6randomABvgZ</span>
_<span style="color:#268bd2">$SSo7UIColorC3red5green4blue5alphaAB12CoreGraphics7CGFloatV_A3ItcfC</span>
_<span style="color:#268bd2">$SSo7UIColorC3red5green4blue5alphaAB12CoreGraphics7CGFloatV_A3ItcfcTO</span>
_<span style="color:#268bd2">$SSo7UIColorCML</span>
_<span style="color:#268bd2">$SSo7UIColorCMa</span>
___swift_reflection_version
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftCoreFoundation_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftCoreGraphics_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftCoreImage_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftDarwin_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftDispatch_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftFoundation_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftMetal_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftObjectiveC_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftQuartzCore_$_ios_framework_package</span>
__swift_FORCE_LOAD_<span style="color:#268bd2">$_swiftUIKit_$_ios_framework_package</span>
_symbolic ____ 21ios_framework_package16FrameworkPackageC
</code></pre></div><p><code>lipo</code> is a bit useless in this case because we were building for a simulator, but <code>nm</code> shows everything we need to know - iOS frameworks symbols are available. Unfortunately, <code>swift build</code> doesn&rsquo;t produce <code>.framework</code> by default. I think it&rsquo;s doable even in this case but let&rsquo;s postpone it &lsquo;till next time&rsquo;.</p>
<h2 id="epilogue-swift-test">Epilogue: swift test</h2>
<p>And the final call. We already have one unit-test for our package, it uses <code>UIKit</code>, and I would mark this experiment as successful if we can run the test target with <code>swift test</code>. It&rsquo;s almost impossible, though, because usually, unit-tests for simulator have to spawn to a simulator process. I do not think that it&rsquo;s even possible for <span class="underline">an actual</span> iOS project. Anyway.</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">swift <span style="color:#cb4b16">test</span> <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-sdk&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;`xcrun --sdk iphonesimulator --show-sdk-path`&#34;</span> <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-target&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;x86_64-apple-ios12.1-simulator&#34;</span>
</code></pre></div><p>And we face another problem. <code>.xctest</code> bundle is compiled but <code>xctest</code> tool is confused with search paths:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Compile Swift Module <span style="color:#2aa198">&#39;ios_framework_package&#39;</span> (<span style="color:#2aa198;font-weight:bold">1</span> sources)
Compile Swift Module <span style="color:#2aa198">&#39;ios_framework_packageTests&#39;</span> (<span style="color:#2aa198;font-weight:bold">2</span> sources)
Linking ./.build/x86_64-apple-macosx10.10/debug/ios-framework-packagePackageTests.xctest/Contents/MacOS/ios-framework-packagePackageTests
xctest[77129:8746476] The bundle ‚Äúios-framework-packagePackageTests.xctest‚Äù couldn‚Äôt be loaded because it is damaged or missing necessary resources. Try reinstalling the bundle.
xctest[77129:8746476](dlopen_preflight(.build/x86_64-apple-macosx10.10/debug/ios-framework-packagePackageTests.xctest/Contents/MacOS/ios-framework-packagePackageTests):

  **Library not loaded: /System/Library/Frameworks/UIKit.framework/UIKit**

  Referenced from: .build/x86_64-apple-macosx10.10/debug/ios-framework-packagePackageTests.xctest/Contents/MacOS/ios-framework-packagePackageTests
  Reason: image not found)
</code></pre></div><p>Likely, <code>swift build &amp; test</code> produce beneficial debug information and store it in <code>.build/debug.yaml</code> with all passed options and arguments. There are no differences with the options for a module itself, so it&rsquo;s time for our command line friends again:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ otool -L .build/debug/ios-framework-packagePackageTests.xctest/Contents/MacOS/ios-framework-packagePackageTests
  /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)
  /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.200.5)
======
  /System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 61000.0.0)
======
  @rpath/XCTest.framework/Versions/A/XCTest (compatibility version 1.0.0, current version 14460.20.0)
  @rpath/libswiftCore.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftCoreFoundation.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftCoreGraphics.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftCoreImage.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftDarwin.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftDispatch.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftFoundation.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftMetal.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftObjectiveC.dylib (compatibility version 1.0.0, current version 1000.11.42)
  @rpath/libswiftQuartzCore.dylib (compatibility version 1.0.0, current version 1000.11.42)
======
  @rpath/libswiftUIKit.dylib (compatibility version 1.0.0, current version 1000.11.42)
======
  @rpath/libswiftXCTest.dylib (compatibility version 1.0.0, current version 1000.11.42)
</code></pre></div><p>As you can see, for some reasons, it tries to link <code>UIKit.framework</code> twice:</p>
<ul>
<li>via <code>/System/Library/Frameworks</code> path</li>
<li>and via expected <code>@rpath/libswiftUIKit.dylib</code>.</li>
</ul>
<p>Let&rsquo;s check the information from the module itself with <code>otool</code>, to be sure that <code>load</code> describes the correct framework to link:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ otool -l .build/debug/ios_framework_package.build/ios_framework_package.swift.o
...
Load <span style="color:#cb4b16">command</span> <span style="color:#2aa198;font-weight:bold">6</span>
     cmd LC_LINKER_OPTION
 cmdsize <span style="color:#2aa198;font-weight:bold">32</span>
   count <span style="color:#2aa198;font-weight:bold">2</span>
  string <span style="color:#93a1a1;font-style:italic">#1 -framework</span>
  string <span style="color:#93a1a1;font-style:italic">#2 UIKit</span>
...
</code></pre></div><p>Seems correct to me. To remove the confusion, let&rsquo;s pass the linking option directly with <code>-Xswiftc &quot;-lswiftUIKit&quot;</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">swift <span style="color:#cb4b16">test</span> --verbose <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-sdk&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;`xcrun --sdk iphonesimulator --show-sdk-path`&#34;</span> <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-target&#34;</span> -Xswiftc <span style="color:#2aa198">&#34;x86_64-apple-ios12.1-simulator&#34;</span> <span style="color:#2aa198">\
</span><span style="color:#2aa198"></span>      -Xswiftc <span style="color:#2aa198">&#34;-lswiftUIKit&#34;</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">xctest[18838:9855653] The bundle ‚Äúios-framework-packagePackageTests.xctest‚Äù couldn‚Äôt be loaded because it is damaged or missing necessary resources. Try reinstalling the bundle.
xctest[18838:9855653]dlopen_preflight(./ios-example/ios-framework-package/.build/x86_64-apple-macosx10.10/debug/ios-framework-packagePackageTests.xctest/Contents/MacOS/ios-framework-packagePackageTests):

      **Library not loaded: @rpath/libswiftUIKit.dylib**
      ...
      Reason: no suitable image found.  Did find:
      /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphonesimulator/libswiftUIKit.dylib: mach-o,

      **but built <span style="color:#859900">for</span> simulator (not macOS)**
</code></pre></div><p>This is the end, my only friend. We can link proper frameworks with minimum efforts, but it&rsquo;s impossible to run these tests for iOS device or simulator without SPM support. It seems that even <code>xcrun</code> with <code>xctest</code> cannot handle it, we need <code>xcodebuild</code> assistance here. Enough these weird logs and useless speeches, let&rsquo;s summarise.</p>
<h2 id="summary">Summary</h2>
<p>Thanks for reading, first of all! And what did we learn?</p>
<ul>
<li>We can use SPM in sporadic cases for iOS just for integration, thanks to <code>.xcconfig</code>;</li>
<li>Future of iOS and SPM friendship is foggy even with this <a href="https://forums.swift.org/t/accepted-with-modifications-se-0236-package-manager-platform-deployment-settings/18420">SE-0236</a> proposal;</li>
<li>Swift <code>build</code> and <code>test</code> helpers are useless for us without iOS-specific features and full Xcode support. And it&rsquo;s unlikely to happen. Of course, SPM can be integrated on top of Xcode by Xcode team. For example, they will extend <code>xcodebuild</code> functionality. But it will be a different story which partly concerns SPM.</li>
</ul>
<p>About SPM. I think that it&rsquo;s doable in general, and we can improve SPM to support any platform you want. My best guess at the moment is to introduce pipeline plugins for SPM. Where you can transfer the control flow to a separate tool with expected input and output. Something like Xcode custom build phases but smarter and more flexible. It will allow SPM to be platform-agnostic as now, but Xcode team can create a plugin for the whole iOS flow support. Or Uber. Or Google. Or me. Whatever.</p>
<p>Stay tuned and hydrated!</p>

			</div>
			
			<a href="/tags/#ios" class="tags">#iOS</a>
			
			<a href="/tags/#spm" class="tags">#SPM</a>
			
			<a href="/tags/#swift" class="tags">#Swift</a>
			
			<div>
				
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/get_current_selected.xcode/">How to get the current selected Xcode and list installed</a></li>
				
				<li><a href="/posts/multiple_xcode_versions_and_xcrun/">Multiple Xcode versions or Why `xcrun` is your friend</a></li>
				
				<li><a href="/posts/twitter_digest_september_2020/">Twitter Digest / October, 2020</a></li>
				
				<li><a href="/posts/grammarly_ios_unboxing/">Grammarly iOS Keyboard - Unboxing</a></li>
				
				<li><a href="/posts/xed_xcode_invocation_tool/">Xcode invocation tool - xed</a></li>
				
			</ul>
		</div>
	</div>
</aside>


    <footer>
  <p>&copy; 2021 <a href="http://dive.github.io/">Just sit and grin</a></p>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
  </body>
</html>
