<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Multiple Xcode versions or Why `xcrun` is your friend</title>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Multiple Xcode versions or Why `xcrun` is your friend"/>
<meta name="twitter:description" content="I recently spent a few hours helping a friend of mine investigate a weird issue in their Continuous Development infrastructure. Builds were failing with different fatal errors mostly related to SDK paths and .platform directory locations. At first sight, it was clear that something is wrong with the current selected Xcode, but all our initial attempts to catch the problem failed."/>

    
    

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">

    
  </head>
  <body>
    <header>
  <div id="header-container">
    <div>
      <span>
        <a href="http://dive.github.io/">Home</a>
        <a href="http://dive.github.io/index.xml">RSS</a>
        
      </span>
    </div>
    <div>
      <span>
        <a href="https://github.com/dive">GitHub</a>
        <a href="https://twitter.com/justsitandgrin">Twitter</a>
        <a href="https://www.linkedin.com/in/artemloenko">LinkedIn</a>
      </span>
    </div>
  </div>
  
</header>

    
	<main>
		<article>
			<h1 class="title">Multiple Xcode versions or Why `xcrun` is your friend</h1>
			<time>08.05.2021 11:12</time>
			<div>
				<p>I recently spent a few hours helping a friend of mine investigate a weird issue in their Continuous Development infrastructure. Builds were failing with different fatal errors mostly related to SDK paths and <code>.platform</code> directory locations. At first sight, it was clear that something is wrong with the current selected Xcode, but all our initial attempts to catch the problem failed.</p>
<p>In the end, we isolated the problem; one of the tools they use changes <code>PATH</code> silently for the environment to simplify access to Xcode tools. Due to their internal logic, the CD pipeline changes a current selected Xcode a few times on the way within the same script. In some cases, the pipeline ended with <code>xcodebuild</code> in the environment&rsquo;s <code>PATH</code> that does not reflect the expected version after the <code>xcode-select --switch</code> command.</p>
<p>How? Pretty easy, actually. A simplified sequence looked like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#93a1a1;font-style:italic"># Innocent tool extends the `PATH`</span>
<span style="color:#93a1a1;font-style:italic"># With the `bin` directory within the current selected Xcode</span>
% <span style="color:#cb4b16">export</span> <span style="color:#268bd2">PATH</span>=<span style="color:#2aa198">&#34;/Xcode_12.5_beta_3.app/Contents/Developer/usr/bin:</span><span style="color:#2aa198">${</span><span style="color:#268bd2">PATH</span><span style="color:#2aa198">}</span><span style="color:#2aa198">&#34;</span>

<span style="color:#93a1a1;font-style:italic"># We change Xcode in a proper way</span>
% sudo xcode-select --switch /Xcode_12.1.app/Contents/Developer

<span style="color:#93a1a1;font-style:italic"># Due to the overridden `PATH`, `xcodebuild` points to an incorrect version</span>
% xcodebuild -version 
Xcode 12.5
Build version 12E5244e

<span style="color:#93a1a1;font-style:italic"># `xcrun` knows the truth</span>
% xcrun xcodebuild -version
Xcode 12.1
Build version 12A7403
</code></pre></div><h2 id="xcrun---invoke-xcode-tools-in-a-safer-way"><code>xcrun</code> - Invoke Xcode tools in a safer way</h2>
<p>According to the documentation:</p>
<blockquote>
<p><code>xcrun</code> provides a means to locate or invoke developer tools from the command-line, without requiring users to modify Makefiles or otherwise take inconvenient measures to support multiple Xcode toolchains.</p>
<p>The tool <code>xcode-select(1)</code> is used to set a system default for the active developer directory and may be overridden by the <code>DEVELOPER_DIR</code> environment variable.</p>
</blockquote>
<p>In real life, it means that you can prefix all the calls to Xcode tools with <code>xcrun</code> on CI/CD to avoid the situation I described in the beginning. Want to run <code>xcodebuild</code> – call it via <code>xcrun xcodebuild</code> command, need to run/invoke simulators, use the <code>xcrun simctl</code> command.</p>
<p>It can save a few hours for your RE/DevOps team at the end of the day. And, depends on the company size, from 5 to 100 hours for your engineers.</p>
<h2 id="what-else">What else?</h2>
<p><code>xcrun</code> has a few additional commands.</p>
<p><code>find</code> – enables &ldquo;find&rdquo; mode, in which the resolved tool path is printed instead of the tool being executed.</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ xcrun --find xcodebuild
/Xcode_12.1.app/Contents/Developer/usr/bin/xcodebuild

$ xcrun --find clang
/Xcode_12.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang
</code></pre></div><p>A few helpers to print paths/versions of the selected SDKs.</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#93a1a1;font-style:italic"># Print the path to the selected SDK</span>
$ xcrun --show-sdk-path
/Xcode_12.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk

<span style="color:#93a1a1;font-style:italic"># Print the version number of the selected SDK</span>
$ xcrun --show-sdk-version
10.15.6

<span style="color:#93a1a1;font-style:italic"># Print the build version number of the selected SDK</span>
$ xcrun --show-sdk-build-version
19G68 

<span style="color:#93a1a1;font-style:italic"># Print the path to the platform for the selected SDK</span>
$ xcrun --show-sdk-platform-path
/Xcode_12.1.app/Contents/Developer/Platforms/MacOSX.platform

<span style="color:#93a1a1;font-style:italic"># Print the version number of the platform for the selected SDK</span>
$ xcrun --show-sdk-platform-version
10.15.6
</code></pre></div><p><code>verbose</code> option shows the logic behind the <code>xcrun</code>. For example, you can see that all the mappings are stored within a temporary <code>xcrun_db</code> and populated on the stage when you select a different Xcode version.</p>
<div class="highlight"><pre tabindex="0" style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">% xcrun --verbose --find git                                              
xcrun: note: <span style="color:#268bd2">PATH</span> = <span style="color:#2aa198">&#39;/Xcode_12.5_beta_3.app/Contents/Developer/usr/bin/:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin&#39;</span>
xcrun: note: <span style="color:#268bd2">SDKROOT</span> = <span style="color:#2aa198">&#39;/Xcode_12.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk&#39;</span>
xcrun: note: <span style="color:#268bd2">TOOLCHAINS</span> = <span style="color:#2aa198">&#39;&#39;</span>
xcrun: note: <span style="color:#268bd2">DEVELOPER_DIR</span> = <span style="color:#2aa198">&#39;/Xcode_12.1.app/Contents/Developer&#39;</span>
xcrun: note: <span style="color:#268bd2">XCODE_DEVELOPER_USR_PATH</span> = <span style="color:#2aa198">&#39;&#39;</span>

<span style="color:#93a1a1;font-style:italic"># The database with all the links</span>
xcrun: note: <span style="color:#268bd2">xcrun_db</span> = <span style="color:#2aa198">&#39;/var/folders/gn/8j0pyrwj5j3ggxprkczkpwtc0000gn/T/xcrun_db&#39;</span>

xcrun: note: xcrun via git (xcrun)
xcrun: note: database key is: git|/Xcode_12.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk||/Xcode_12.1.app/Contents/Developer|
xcrun: note: lookup resolved in <span style="color:#2aa198">&#39;/var/folders/gn/8j0pyrwj5j3ggxprkczkpwtc0000gn/T/xcrun_db&#39;</span> : <span style="color:#2aa198">&#39;/Xcode_12.1.app/Contents/Developer/usr/bin/git&#39;</span>
/Xcode_12.1.app/Contents/Developer/usr/bin/git
</code></pre></div><h2 id="side-notes">Side notes</h2>
<ul>
<li>Check the previous note about <code>xed</code> – <a href="https://gist.github.com/dive/8d8f222f6851afaea338f853c7d51410">Xcode invocation tool</a></li>
<li>Create a minor task for your DevOps team to prefix all the calls to Xcode tools with <code>xcrun</code></li>
</ul>
<hr>
<p>Follow me on Twitter – <a href="https://twitter.com/justsitandgrin">@justsitandgrin</a></p>
			</div>
			
			<a href="/tags/#xcode" class="tags">#Xcode</a>
			
			<a href="/tags/#xcrun" class="tags">#xcrun</a>
			
			<div>
				
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/get_current_selected.xcode/">How to get the current selected Xcode and list installed</a></li>
				
				<li><a href="/posts/multiple_xcode_versions_and_xcrun/">Multiple Xcode versions or Why `xcrun` is your friend</a></li>
				
				<li><a href="/posts/twitter_digest_september_2020/">Twitter Digest / October, 2020</a></li>
				
				<li><a href="/posts/grammarly_ios_unboxing/">Grammarly iOS Keyboard - Unboxing</a></li>
				
				<li><a href="/posts/xed_xcode_invocation_tool/">Xcode invocation tool - xed</a></li>
				
			</ul>
		</div>
	</div>
</aside>


    <footer>
  <p>&copy; 2021 <a href="http://dive.github.io/">Just sit and grin</a></p>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
  </body>
</html>
